name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Install XcodeGen
      run: |
        brew install xcodegen
        
    - name: Organize Project Structure
      run: |
        # Create the app directory structure
        mkdir -p CareerFairLoginApp
        
        # Move Swift files to the app directory
        mv CareerFairLoginAppApp.swift CareerFairLoginApp/ 2>/dev/null || true
        mv Models CareerFairLoginApp/ 2>/dev/null || true
        mv Views CareerFairLoginApp/ 2>/dev/null || true
        
        # Create Info.plist
        cat > CareerFairLoginApp/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleDisplayName</key>
            <string>CareerFairLoginApp</string>
            <key>CFBundleExecutable</key>
            <string>\$(EXECUTABLE_NAME)</string>
            <key>CFBundleIdentifier</key>
            <string>\$(PRODUCT_BUNDLE_IDENTIFIER)</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>\$(PRODUCT_NAME)</string>
            <key>CFBundlePackageType</key>
            <string>\$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UIApplicationSceneManifest</key>
            <dict>
                <key>UIApplicationSupportsMultipleScenes</key>
                <true/>
            </dict>
            <key>UILaunchScreen</key>
            <dict/>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
        </dict>
        </plist>
        EOF
        
    - name: Generate Xcode Project
      run: |
        xcodegen generate
        
    - name: List Available Simulators
      run: |
        xcrun simctl list devices available
        
    - name: Get Simulator Device
      run: |
        # Pick the first available iPhone simulator
        LINE=$(xcrun simctl list devices available | grep "iPhone" | head -1)
        echo "Raw device line: $LINE"

        # Extract UDID (second () group) and name (text before first ()
        DEVICE_UDID=$(echo "$LINE" | awk -F '[()]' '{print $2}')
        DEVICE_NAME=$(echo "$LINE" | cut -d '(' -f1 | xargs)

        if [ -z "$DEVICE_UDID" ]; then
          echo "Failed to detect simulator UDID"
          exit 1
        fi

        echo "DEVICE_UDID=$DEVICE_UDID" >> $GITHUB_ENV
        echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
        echo "Using device: $DEVICE_NAME ($DEVICE_UDID)"
        
    - name: Boot Simulator
      run: |
        xcrun simctl boot "$DEVICE_UDID" || true
        
    - name: Build App
      run: |
        xcodebuild clean build \
          -project CareerFairLoginApp.xcodeproj \
          -scheme CareerFairLoginApp \
          -destination "platform=iOS Simulator,id=$DEVICE_UDID" \
          -derivedDataPath ./build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        
    - name: Install App on Simulator
      run: |
        # Find the built app in derived data
        APP_PATH=$(find ./build -name "CareerFairLoginApp.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "App not found, searching all locations..."
          find . -name "*.app" -type d
          exit 1
        fi
        echo "Installing app from: $APP_PATH"
        xcrun simctl install "$DEVICE_UDID" "$APP_PATH"
        
    - name: Launch App and Take Screenshots
      run: |
        # Launch the app
        xcrun simctl launch "$DEVICE_UDID" com.hkbu.CareerFairLoginApp

        # Wait for app to load
        sleep 5

        # Create screenshots directory
        mkdir -p screenshots

        # Take screenshot of the app
        xcrun simctl io "$DEVICE_UDID" screenshot screenshots/login-screen.png

        # Wait a bit more and take another screenshot
        sleep 2
        xcrun simctl io "$DEVICE_UDID" screenshot screenshots/app-running.png

        echo "Screenshots saved!"
        ls -la screenshots/
        
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: app-screenshots
        path: screenshots/
        retention-days: 30
        
    - name: Build Summary
      run: |
        echo "‚úÖ Build completed successfully!"
        echo "üì± Screenshots are available in the Artifacts section"
        echo "üîç Check the 'app-screenshots' artifact to see your app running"
