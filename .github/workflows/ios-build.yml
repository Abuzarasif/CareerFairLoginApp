name: Build iOS App (Syntax Check)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode and SDK version
        run: |
          xcodebuild -version
          xcrun --show-sdk-path --sdk iphonesimulator

      - name: Organize Project Structure
        run: |
          # Create the app directory structure
          mkdir -p CareerFairLoginApp

          # Move Swift files to the app directory
          mv CareerFairLoginAppApp.swift CareerFairLoginApp/ 2>/dev/null || true
          mv Models CareerFairLoginApp/ 2>/dev/null || true
          mv Views CareerFairLoginApp/ 2>/dev/null || true

          # Create Info.plist
          cat > CareerFairLoginApp/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleDisplayName</key>
              <string>CareerFairLoginApp</string>
              <key>CFBundleExecutable</key>
              <string>\$(EXECUTABLE_NAME)</string>
              <key>CFBundleIdentifier</key>
              <string>\$(PRODUCT_BUNDLE_IDENTIFIER)</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>\$(PRODUCT_NAME)</string>
              <key>CFBundlePackageType</key>
              <string>\$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UIApplicationSceneManifest</key>
              <dict>
                  <key>UIApplicationSupportsMultipleScenes</key>
                  <true/>
              </dict>
              <key>UILaunchScreen</key>
              <dict/>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>armv7</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
          </dict>
          </plist>
          EOF

      - name: Verify Swift Files
        run: |
          echo "Swift files in repository:"
          find . -name "*.swift" -type f | sort

      - name: Swift Syntax Check (all files together)
        run: |
          SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
          echo "Using SDK: $SDK_PATH"

          cd CareerFairLoginApp
          echo "Checking Swift syntax for all Swift files in a single compilation..."

          FILES=$(find . -name "*.swift" -type f | sort)
          echo "Files:"
          echo "$FILES"

          # Use -parse-as-library so that the @main App struct is allowed while
          # still type-checking the whole target as one module.
          swiftc -typecheck \
            -sdk "$SDK_PATH" \
            -target arm64-apple-ios16.0-simulator \
            -parse-as-library \
            $FILES

          echo "âœ… All Swift files passed combined syntax check."