name: Build iOS App (Syntax & Screenshots)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode and SDK version
        run: |
          xcodebuild -version
          xcrun --show-sdk-path --sdk iphonesimulator

      - name: Organize Project Structure
        run: |
          # Create the app directory structure
          mkdir -p CareerFairLoginApp

          # Move Swift files to the app directory
          mv CareerFairLoginAppApp.swift CareerFairLoginApp/ 2>/dev/null || true
          mv Models CareerFairLoginApp/ 2>/dev/null || true
          mv Views CareerFairLoginApp/ 2>/dev/null || true

          # Create Info.plist
          cat > CareerFairLoginApp/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleDisplayName</key>
              <string>CareerFairLoginApp</string>
              <key>CFBundleExecutable</key>
              <string>\$(EXECUTABLE_NAME)</string>
              <key>CFBundleIdentifier</key>
              <string>\$(PRODUCT_BUNDLE_IDENTIFIER)</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>\$(PRODUCT_NAME)</string>
              <key>CFBundlePackageType</key>
              <string>\$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UIApplicationSceneManifest</key>
              <dict>
                  <key>UIApplicationSupportsMultipleScenes</key>
                  <true/>
              </dict>
              <key>UILaunchScreen</key>
              <dict/>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>armv7</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
          </dict>
          </plist>
          EOF

      - name: Verify Swift Files
        run: |
          echo "Swift files in repository:"
          find . -name "*.swift" -type f | sort

      - name: Swift Syntax Check (all files together)
        run: |
          SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
          echo "Using SDK: $SDK_PATH"

          cd CareerFairLoginApp
          echo "Checking Swift syntax for all Swift files in a single compilation..."

          FILES=$(find . -name "*.swift" -type f | sort)
          echo "Files:"
          echo "$FILES"

          # Use -parse-as-library so that the @main App struct is allowed while
          # still type-checking the whole target as one module.
          swiftc -typecheck \
            -sdk "$SDK_PATH" \
            -target arm64-apple-ios16.0-simulator \
            -parse-as-library \
            $FILES

          echo "âœ… All Swift files passed combined syntax check."

      - name: Install XcodeGen
        run: |
          brew install xcodegen

      - name: Generate Xcode Project
        run: |
          xcodegen generate

      - name: Find Simulator Destination
        run: |
          echo "=== xcodebuild -showdestinations output (filtered) ==="
          xcodebuild -project CareerFairLoginApp.xcodeproj \
            -scheme CareerFairLoginApp \
            -sdk iphonesimulator \
            -showdestinations 2>&1 | grep "platform:iOS Simulator" || true

          # Pick the first real simulator destination that has an 'id:' field.
          DEST_LINE=$(xcodebuild -project CareerFairLoginApp.xcodeproj \
            -scheme CareerFairLoginApp \
            -sdk iphonesimulator \
            -showdestinations 2>&1 | grep "platform:iOS Simulator" | grep "id:" | head -1)

          if [ -z "$DEST_LINE" ]; then
            echo "ERROR: Could not find a specific iOS Simulator destination with an id."
            echo "Full destination list:"
            xcodebuild -project CareerFairLoginApp.xcodeproj \
              -scheme CareerFairLoginApp \
              -sdk iphonesimulator \
              -showdestinations 2>&1 || true
            # We won't fail here; later steps will fall back to a generic destination.
          fi
          fi

          DEST_ID=$(echo "$DEST_LINE" | sed -n 's/.*id:\([A-F0-9-]*\).*/\1/p' | head -1)
          DEST_NAME=$(echo "$DEST_LINE" | sed -n 's/.*name:\([^,}]*\).*/\1/p' | head -1 | xargs)

          echo "DEST_LINE=$DEST_LINE"
          echo "DEST_ID=$DEST_ID" >> $GITHUB_ENV
          echo "DEST_NAME=$DEST_NAME" >> $GITHUB_ENV

      - name: Build App
        run: |
          echo "DEST_ID=$DEST_ID"
          echo "DEST_NAME=$DEST_NAME"

          if [ -n "$DEST_ID" ]; then
            DEST_SPEC="platform=iOS Simulator,id=$DEST_ID"
          else
            echo "Warning: No simulator ID available, using a generic iOS Simulator destination."
            DEST_SPEC="generic/platform=iOS Simulator"
          fi

          echo "Using destination specifier: $DEST_SPEC"

          xcodebuild clean build \
            -project CareerFairLoginApp.xcodeproj \
            -scheme CareerFairLoginApp \
            -destination "$DEST_SPEC" \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Boot Simulator
        run: |
          xcrun simctl boot "$DEST_ID" || true
          xcrun simctl bootstatus "$DEST_ID" -b

      - name: Install App on Simulator
        run: |
          APP_PATH=$(find ./build -name "CareerFairLoginApp.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "App not found in derived data"
            exit 1
          fi
          echo "Installing app from $APP_PATH"
          xcrun simctl install "$DEST_ID" "$APP_PATH"

      - name: Launch App and Take Screenshots
        run: |
          mkdir -p screenshots

          xcrun simctl launch "$DEST_ID" com.hkbu.CareerFairLoginApp || true
          sleep 5

          xcrun simctl io "$DEST_ID" screenshot screenshots/login.png
          sleep 2
          xcrun simctl io "$DEST_ID" screenshot screenshots/tab-home.png
          sleep 2
          xcrun simctl io "$DEST_ID" screenshot screenshots/tab-exhibitors.png

          ls -la screenshots

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: app-screenshots
          path: screenshots
          retention-days: 30